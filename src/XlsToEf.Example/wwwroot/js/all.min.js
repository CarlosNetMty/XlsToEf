App={Import:{}},App.Import.ImportReady=function(e,t,a){var n="",o={},r={},s={};$("#fileupload").fileupload({url:e,dataType:"json",autoUpload:!0,acceptFileTypes:/(\.|\/)(xlsx)$/i,maxFileSize:5e6}).on("fileuploadadd",function(e,t){$("#progress").toggle(!0),t.context=$("<div/>").appendTo("#files"),$.each(t.files,function(e,a){var n=$("<p/>").append($("<span/>").append($("<strong/>").text("File: "))).append($("<span/>").text(a.name)).append($("<br />"));e||$(".fileinput-button").hide(),n.appendTo(t.context)})}).on("fileuploadprogressall",function(e,t){var a=parseInt(t.loaded/t.total*100,10);$("#progress .progress-bar").css("width",a+"%")}).on("fileuploaddone",function(e,t){if(n=t.result.file,t.url){var a=$('<select class="form-control" id="sheetPicker" />');a.append($("<option />")),$.each(t.result.sheets,function(e){var n=t.result.sheets[e];a.append($("<option />",{value:n}).text(n))}),$("#sheets").append($("<span />").append($("<strong/>").text("Sheet"))).append(a);var o=$('<select class="form-control" id="destinationPicker" />');o.append($("<option />")),r=t.result.destinations,$.each(r,function(e){o.append($("<option />",{value:r[e].name}).text(r[e].name))}),$("#destinations").append($("<span />").append($("<strong/>").text("Destination"))).append(o)}else if(t.result.error){var s=$('<span class="text-danger"/>').text(t.result.error);$(t.context.children()[0]).append("<br>").append(s)}}).on("fileuploadfail",function(e,t){$.each(t.files,function(e){var a=$('<span class="text-danger"/>').text("File upload failed.");$(t.context.children()[e]).append("<br>").append(a)})}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),$(".modal-body").on("change","#sheetPicker, #destinationPicker",function(){var e=r.filter(function(e){return e.name==$("#destinationPicker").val()})[0];return void 0==e||0==!!$("#sheetPicker").val()?($("#matcherDisplay").toggle(!1),$("#ap-run").toggle(!1),void $("#matchRows").empty()):void $.ajax(e.selectSheetUrl,{type:"POST",data:JSON.stringify({Sheet:$("#sheetPicker").val(),FileName:n,Destination:e}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){$("#matcherDisplay").toggle(!0),$("#ap-run").toggle(!0);var t=1;$("#matchRows").empty(),o={},s=e.requiredTogether;for(var a in e.tableColumns){var n=e.tableColumns[a],r=n.name,p=n.required,l=$('<select class="form-control" />');p&&l.addClass("colRequired"),o[a]=l,l.append($("<option />")),$("#matchRows").append($("<tr />").append($("<td />").append($('<span class="center-vertical" />').text(t))).append($('<td class="form-group" />').append(l)).append($("<td />").text(r))),$.each(e.xlsxColumns,function(t){var a=e.XlsxColumns[t];l.append($("<option>",{value:a}).text(a))}),t++}}).fail(function(e){alert("error")})}),$("#ap-run").on("click",function(){var e=($(this),!0);if($("#matchRows select.colRequired").each(function(){var t=!!this.value;t||(e=!1,$(this).closest(".form-group").addClass("has-error"))}),s.length>0&&s.forEach(function(t){var a=0;for(var n in o)$.inArray(n,t)>-1&&o[n].val()&&a++;a>0&&a<t.length?(e=!1,t.forEach(function(e){o[e].val()||o[e].parent().addClass("has-error")})):t.forEach(function(e){o[e].parent().removeClass("has-error")})}),e){var p={FileName:n,Selected:{},Sheet:$("#sheetPicker").val()};for(var l in o)o[l].val()&&(p.Selected[l]=o[l].val());var i=r.filter(function(e){return e.Name==$("#destinationPicker").val()})[0];$.ajax(i.MatchSubmitUrl,{type:"POST",data:JSON.stringify(p),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){if($.isEmptyObject(e.RowErrorDetails))toastr.success(t+" was successfully updated"),$("#"+a).modal("hide");else{var n=$(".modal-body");n.empty();var o=1==e.SuccessCount?"row.":"rows.";n.append($("<p />").text("Successfully imported "+e.SuccessCount+" "+o)),n.append($("<span />").text("The following rows could not be imported:"));var r=$('<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table" />');r.empty();for(var s in e.RowErrorDetails)r.append($('<tr class="importErrorRow" />').append($("<td />").text(s)).append($("<td />").text(e.RowErrorDetails[s])));n.append(r),n.append($("<span />").text("Please correct the Excel file and try to import it again.")),$("#ap-close").addClass("btn-primary").removeClass("btn-default").text("Close"),$("#ap-run").hide()}}).fail(function(e){alert("Error - failed to import")}).always(function(){})}}),$("#ap-run").toggle(!1),$(".modal-body").on("change","#matchRows select",function(){$("#matchRows select").each(function(){var e=!!this.value;e&&$(this).closest(".form-group").removeClass("has-error")})}),$("#matcherDisplay").toggle(!1),$("#progress").toggle(!1)};